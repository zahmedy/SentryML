version: "3.9"

services:
  db:
    image: postgres:16
    environment:
      POSTGRES_DB: sentryml
      POSTGRES_USER: sentryml
      POSTGRES_PASSWORD: sentryml
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  api:
    build:
      context: .
      dockerfile: Dockerfile
    command: >
      uvicorn apps.api.app.main:app
      --host 0.0.0.0
      --port 8000
    environment:
      - DATABASE_URL=postgresql://sentryml:sentryml@db:5432/sentryml
      - API_KEY_SECRET=dev-secret
      - ADMIN_EMAIL=admin@sentryml.dev
      - ADMIN_PASSWORD=changeme
      - ORG_NAME=Demo Org
    depends_on:
      - db
    ports:
      - "8000:8000"

  worker:
    build:
      context: .
      dockerfile: Dockerfile
    command: >
      sh -c "printf 'PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\nDATABASE_URL=%s\nAPI_KEY_SECRET=%s\n*/15 * * * * cd /app && /usr/local/bin/python -m apps.worker.worker.run_once >> /proc/1/fd/1 2>> /proc/1/fd/2\n\n' \"${DATABASE_URL}\" \"${API_KEY_SECRET}\" > /etc/cron.d/worker && chmod 0644 /etc/cron.d/worker && crontab /etc/cron.d/worker && cron -f"
    environment:
      DATABASE_URL: postgresql+psycopg2://sentryml:sentryml@db:5432/sentryml
      API_KEY_SECRET: dev-secret
    depends_on:
      - db

  ui:
    build:
      context: .
      dockerfile: Dockerfile
    command: >
      uvicorn apps.ui.main:app
      --host 0.0.0.0
      --port 9000
    environment:
      API_BASE_URL: http://api:8000
    depends_on:
      - api
    ports:
      - "9000:9000"

volumes:
  postgres_data:
