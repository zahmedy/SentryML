{% extends "base.html" %}
{% block content %}

<div class="section-header">
  <h2 class="section-title">Model: {{ model_id }}</h2>
  <div class="section-sub"><a href="/dashboard">Back to dashboard</a></div>
</div>

<div class="card" style="margin:12px 0 18px;">
  <div style="display:flex; align-items:center; justify-content:space-between;">
    <div style="font-weight:700;">Monitoring</div>
    {% if monitor and monitor.is_enabled %}
      <span class="badge badge-ok">Enabled</span>
    {% else %}
      <span class="badge badge-neutral">Disabled</span>
    {% endif %}
  </div>
  <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:12px; margin-top:10px;">
    <div>
      <div class="muted">Baseline days</div>
      <div>{{ monitor.baseline_days if monitor else 7 }}</div>
    </div>
    <div>
      <div class="muted">Current days</div>
      <div>{{ monitor.current_days if monitor else 1 }}</div>
    </div>
    <div>
      <div class="muted">Warn threshold</div>
      <div>{{ (monitor.warn_threshold if monitor else 0.1)|fmt_num }}</div>
    </div>
    <div>
      <div class="muted">Critical threshold</div>
      <div>{{ (monitor.critical_threshold if monitor else 0.2)|fmt_num }}</div>
    </div>
  </div>
  <p class="muted" style="margin-top:10px;">
    Defaults work well for most models. If you need custom thresholds, contact us or edit via API.
  </p>
</div>

<h3>Incidents</h3>
<p style="color:#666; margin-top:-6px;">
  Resolved automatically when PSI returns to normal.
</p>
{% if incidents|length == 0 %}
  <p>No incidents for this model.</p>
{% else %}
<div class="table-wrap">
<table border="0" cellpadding="6" cellspacing="0" width="100%">
  <tr>
    <th>Incident</th>
    <th>State</th>
    <th>PSI</th>
    <th>Opened</th>
    <th>Closed</th>
  </tr>
  {% for i in incidents %}
  <tr>
    <td>
      <a href="/incidents/{{ i.incident_id }}">
        {{ i.state }} ({{ (i.incident_id|string)[:10] }})
      </a>
    </td>
    <td>{{ i.state }}</td>
    <td>{{ i.value|fmt_num }}</td>
    <td>{{ i.opened_at|fmt_dt }}</td>
    <td>{{ i.closed_at|fmt_dt }}</td>
  </tr>
  {% endfor %}
</table>
</div>
{% endif %}

<h3 style="margin-top:20px;">Drift History</h3>
<form method="get" action="/models/{{ model_id }}" style="margin:10px 0;">
  <label>Show last</label>
  <select name="drift_limit" onchange="this.form.submit()">
    <option value="50"  {% if drift_limit == 50 %}selected{% endif %}>50</option>
    <option value="200" {% if drift_limit == 200 %}selected{% endif %}>200</option>
    <option value="1000" {% if drift_limit == 1000 %}selected{% endif %}>1000</option>
  </select>
  <input type="hidden" name="pred_limit" value="{{ pred_limit }}" />
</form>
{% if drift|length == 0 %}
  <p>No drift results yet.</p>
{% else %}
<div class="table-wrap" style="max-height:450px; overflow-y:auto;">
<table border="0" cellpadding="6" cellspacing="0" width="100%">
  <tr>
    <th>Drift ID</th>
    <th>Computed</th>
    <th>PSI</th>
    <th>Baseline</th>
    <th>Current</th>
  </tr>
  {% for d in drift %}
  <tr id="drift-{{ d.drift_id }}">
    <td>{{ (d.drift_id|string)[:10] }}</td>
    <td>{{ d.computed_at|fmt_dt }}</td>
    <td>{{ d.psi_score|fmt_num }}</td>
    <td>{{ d.baseline_start|fmt_dt }} → {{ d.baseline_end|fmt_dt }} (n={{ d.baseline_n }})</td>
    <td>{{ d.current_start|fmt_dt }} → {{ d.current_end|fmt_dt }} (n={{ d.current_n }})</td>
  </tr>
  {% endfor %}
</table>
</div>
{% endif %}

<h3 style="margin-top:20px;">Recent Predictions</h3>
<p style="color:#666; margin-top:-6px;">
  Showing recent events only.
</p>

<form method="get" action="/models/{{ model_id }}" style="margin:10px 0;">
  <label>Show last</label>
  <select name="pred_limit" onchange="this.form.submit()">
    <option value="50"  {% if pred_limit == 50 %}selected{% endif %}>50</option>
    <option value="200" {% if pred_limit == 200 %}selected{% endif %}>200</option>
    <option value="1000" {% if pred_limit == 1000 %}selected{% endif %}>1000</option>
  </select>
</form>

{% if recent_predictions|length == 0 %}
  <p>No prediction events yet.</p>
{% else %}
<div class="table-wrap" style="max-height:450px; overflow-y:auto;">
  <table border="0" cellpadding="6" cellspacing="0" width="100%">
    <tr>
      <th>Time</th>
      <th>Entity</th>
      <th>Prediction</th>
      <th>Score</th>
    </tr>
    {% for p in recent_predictions %}
    <tr>
      <td>{{ p.event_time|fmt_dt }}</td>
      <td>{{ p.entity_id }}</td>
      <td>{{ p.prediction }}</td>
      <td>
        {% if p.score is not none %}
          {{ p.score|fmt_num }}
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </table>
</div>
{% endif %}

{% endblock %}
