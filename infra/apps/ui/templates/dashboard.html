{% extends "base.html" %}
{% block content %}

<h2>Dashboard</h2>

{% if models|length == 0 %}
  <div class="onboarding">
    <div class="onboarding-header">
      <h3 class="onboarding-title">Welcome to SentryML</h3>
    </div>
    <p class="onboarding-body">
      SentryML monitors production ML models for data drift and turns distribution shifts into actionable incidents.
      Get started by sending prediction events — your models will appear automatically.
    </p>

    <div class="steps">
      <div class="step">
        <div class="step-title">Create an API key</div>
        <div class="step-desc">API keys authenticate prediction events from your application.</div>
        <a href="/settings/api-keys" class="cta-link">
          {% if has_keys %}✓ API key created{% else %}Create API key{% endif %}
        </a>
      </div>
      <div class="step">
        <div class="step-title">Send prediction events</div>
        <div class="step-desc">Send predictions from your application. Models appear automatically when events are received.</div>
        <pre class="code-block">curl -X POST /v1/events/prediction \
  -H "X-API-Key: sk_live_..." \
  -H "Content-Type: application/json" \
  -d '{
    "model_id": "fraud_v1",
    "entity_id": "user_123",
    "prediction": "approve",
    "score": 0.87,
    "event_time": "2026-01-16T12:00:00Z"
  }'</pre>
        <div class="step-desc">
          You only need to send predictions — SentryML handles aggregation and drift detection.
        </div>
      </div>
      <div class="step">
        <div class="step-title">Enable monitoring</div>
        <div class="step-muted">Available after your first model appears.</div>
      </div>
    </div>

    <div class="trust">
      Monitoring runs on a scheduled worker. Incidents resolve automatically when data returns to normal.
    </div>
  </div>
{% else %}
  {% if show_model_detected %}
    <div class="notice">
      <b>Model detected</b>
      <div style="color:#374151; margin-top:6px;">
        We’ve started tracking prediction events for your model.
        Enable monitoring to begin drift detection.
      </div>
    </div>
  {% endif %}
  <div class="section-header">
    <h3 class="section-title">Models</h3>
    <div class="section-sub">You can disable monitoring at any time.</div>
  </div>
  <div class="table-wrap">
  <table border="0" cellpadding="8" cellspacing="0">
  <thead>
    <tr>
      <th>Model</th>
      <th>Events</th>
      <th>Last Seen</th>
      <th>Last PSI</th>
      <th>Drift</th>
      <th>Incident</th>
      <th>Monitoring</th>
    </tr>
  </thead>
  <tbody>
    {% for m in models %}
    <tr>
      <!-- Model -->
      <td>
        <a href="/models/{{ m.model_id }}" data-model-id="{{ m.model_id }}">{{ m.model_id }}</a>
      </td>

      <!-- Events -->
      <td>{{ m.event_count or 0 }}</td>

      <!-- Last Seen -->
      <td>{{ m.last_seen_at|fmt_dt }}</td>

      <!-- Last PSI -->
      <td>
        {{ m.last_psi_score|fmt_num }}
      </td>

      <!-- Drift -->
      <td>
        {% if m.drift_severity == "ok" %}
          <span class="badge badge-ok">ok</span>
        {% elif m.drift_severity == "warn" %}
          <span class="badge badge-warn">warn</span>
        {% elif m.drift_severity == "critical" %}
          <span class="badge badge-critical">critical</span>
        {% else %}
          <span class="badge badge-neutral">—</span>
        {% endif %}
      </td>

      <!-- Incident -->
      <td>
        {% if m.open_incident_id %}
          <a href="/incidents/{{ m.open_incident_id }}">
            {% if m.open_incident_severity == "warn" %}
              <span class="badge badge-warn">{{ m.open_incident_status }}</span>
            {% elif m.open_incident_severity == "critical" %}
              <span class="badge badge-critical">{{ m.open_incident_status }}</span>
            {% else %}
              <span class="badge badge-neutral">{{ m.open_incident_status }}</span>
            {% endif %}
            <span class="muted">({{ (m.open_incident_id|string)[:10] }})</span>
          </a>
        {% else %}
          <span class="badge badge-neutral">—</span>
        {% endif %}
      </td>

      <!-- Monitoring -->
      <td>
        {% if m.monitor_enabled %}
          Enabled
          <form
            action="/models/{{ m.model_id }}/monitoring/disable"
            method="post"
            style="display:inline"
          >
            <button type="submit">Disable</button>
          </form>
        {% else %}
          <div>Disabled</div>
          <form
            action="/models/{{ m.model_id }}/monitoring/enable"
            method="post"
            style="display:inline"
          >
            <button type="submit">Enable</button>
          </form>
          <div class="muted" style="margin-top:4px;">
            Monitoring runs on the next scheduled worker cycle.
          </div>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
  </div>
{% endif %}

<script>
  (function () {
    const key = "sentryml_seen_models";
    const seen = new Set(JSON.parse(sessionStorage.getItem(key) || "[]"));
    const links = document.querySelectorAll("a[data-model-id]");
    links.forEach((link) => {
      const id = link.getAttribute("data-model-id");
      if (id && !seen.has(id)) {
        const badge = document.createElement("span");
        badge.textContent = "New";
        badge.style.marginLeft = "6px";
        badge.style.fontSize = "0.7em";
        badge.style.background = "#111827";
        badge.style.color = "#fff";
        badge.style.padding = "2px 6px";
        badge.style.borderRadius = "999px";
        link.appendChild(badge);
      }
      if (id) seen.add(id);
    });
    sessionStorage.setItem(key, JSON.stringify(Array.from(seen)));
  })();
</script>
{% endblock %}
