{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}

<div class="page-header">
  <h1 class="page-title">Dashboard</h1>
  <p class="page-subtitle">Monitor your ML models for data drift and performance issues</p>
</div>

{% if models|length == 0 %}
  <div class="onboarding">
    <div class="onboarding-header">
      <h2 class="onboarding-title">Welcome to SentryML</h2>
    </div>
    <p class="onboarding-body">
      SentryML monitors production ML models for data drift and turns distribution shifts into actionable incidents.
      Get started by sending prediction events — your models will appear automatically.
    </p>

    <div class="steps">
      <div class="step">
        <div class="step-number">1</div>
        <h3 class="step-title">Create an API key</h3>
        <p class="step-desc">API keys authenticate prediction events from your application.</p>
        <a href="/settings/api-keys" class="cta-link">
          {% if has_keys %}✓ API key created{% else %}Create API key →{% endif %}
        </a>
      </div>
      <div class="step">
        <div class="step-number">2</div>
        <h3 class="step-title">Send prediction events</h3>
        <p class="step-desc">Send predictions from your application. Models appear automatically when events are received.</p>
        <pre class="code-block">curl -X POST /v1/events/prediction \
  -H "X-API-Key: sk_live_..." \
  -H "Content-Type: application/json" \
  -d '{
    "model_id": "fraud_v1",
    "entity_id": "user_123",
    "prediction": "approve",
    "score": 0.87,
    "event_time": "2026-01-16T12:00:00Z"
  }'</pre>
        <p class="step-desc" style="margin-top: 12px;">
          You only need to send predictions — SentryML handles aggregation and drift detection.
        </p>
      </div>
      <div class="step">
        <div class="step-number">3</div>
        <h3 class="step-title">Enable monitoring</h3>
        <p class="step-desc">Configure drift thresholds and alerts for your models.</p>
        <p class="muted" style="margin-top: 12px;">Available after your first model appears</p>
      </div>
    </div>

    <div class="notice notice-info" style="margin-top: 24px;">
      <strong>Automated monitoring:</strong> Monitoring runs every 15 minutes on a scheduled worker. Incidents resolve automatically when data returns to normal.
    </div>
  </div>
{% else %}
  <div id="model-detected" class="notice notice-info" style="display:none;">
    <strong>Model detected!</strong><br>
    We've started tracking prediction events for your model.
    Enable monitoring to begin drift detection.
  </div>

  <!-- Stats Overview -->
  <div class="card-grid" style="margin-bottom: 32px;">
    <div class="card">
      <div class="card-body">
        <div class="muted" style="font-size: 13px; margin-bottom: 4px;">Total Models</div>
        <div style="font-size: 32px; font-weight: 700; color: var(--color-gray-900);">{{ models|length }}</div>
      </div>
    </div>
    <div class="card">
      <div class="card-body">
        <div class="muted" style="font-size: 13px; margin-bottom: 4px;">Active Monitoring</div>
        <div style="font-size: 32px; font-weight: 700; color: var(--color-gray-900);">
          {{ models|selectattr('monitor_enabled')|list|length }}
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-body">
        <div class="muted" style="font-size: 13px; margin-bottom: 4px;">Open Incidents</div>
        <div style="font-size: 32px; font-weight: 700; color: var(--color-gray-900);">
          {{ models|selectattr('open_incident_id')|list|length }}
        </div>
      </div>
    </div>
  </div>

  <div class="section-header">
    <div>
      <h2 class="section-title">Models</h2>
    </div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Model</th>
          <th>Events</th>
          <th>Last Seen</th>
          <th>Last PSI</th>
          <th>Drift Status</th>
          <th>Incident</th>
          <th>Monitoring</th>
        </tr>
      </thead>
      <tbody>
        {% for m in models %}
        <tr>
          <!-- Model -->
          <td>
            <a href="/models/{{ m.model_id }}" data-model-id="{{ m.model_id }}" data-first-seen="{{ m.first_seen_at }}" style="font-weight: 500; font-size: 14px;">
              {{ m.model_id }}
            </a>
          </td>

          <!-- Events -->
          <td>
            <span style="font-weight: 500;">{{ m.event_count or 0 }}</span>
          </td>

          <!-- Last Seen -->
          <td class="muted">{{ m.last_seen_at|fmt_dt }}</td>

          <!-- Last PSI -->
          <td>
            <span style="font-weight: 500; {% if m.last_psi_score and m.last_psi_score > 0.2 %}color: var(--color-danger-600);{% endif %}">
              {{ m.last_psi_score|fmt_num if m.last_psi_score else '—' }}
            </span>
          </td>

          <!-- Drift -->
          <td>
            {% if m.drift_severity == "ok" %}
              <span class="badge badge-ok"><span class="status-dot"></span> OK</span>
            {% elif m.drift_severity == "warn" %}
              <span class="badge badge-warn"><span class="status-dot"></span> Warning</span>
            {% elif m.drift_severity == "critical" %}
              <span class="badge badge-critical"><span class="status-dot"></span> Critical</span>
            {% else %}
              <span class="badge badge-neutral">—</span>
            {% endif %}
          </td>

          <!-- Incident -->
          <td>
            {% if m.open_incident_id %}
              <a href="/incidents/{{ m.open_incident_id }}" style="display: flex; align-items: center; gap: 6px;">
                {% if m.open_incident_severity == "warn" %}
                  <span class="badge badge-warn">{{ m.open_incident_status }}</span>
                {% elif m.open_incident_severity == "critical" %}
                  <span class="badge badge-critical">{{ m.open_incident_status }}</span>
                {% else %}
                  <span class="badge badge-neutral">{{ m.open_incident_status }}</span>
                {% endif %}
                <span class="muted text-xs">#{{ (m.open_incident_id|string)[:8] }}</span>
              </a>
            {% else %}
              <span class="badge badge-neutral">None</span>
            {% endif %}
          </td>

          <!-- Monitoring -->
          <td>
            <div style="display: flex; align-items: center; gap: 8px;">
              {% if m.monitor_enabled %}
                <span class="badge badge-ok">Enabled</span>
                <form
                  action="/models/{{ m.model_id }}/monitoring/disable"
                  method="post"
                  style="display: inline;"
                >
                  <button type="submit" class="btn-sm btn-ghost">Disable</button>
                </form>
              {% else %}
                <span class="badge badge-neutral">Disabled</span>
                <form
                  action="/models/{{ m.model_id }}/monitoring/enable"
                  method="post"
                  style="display: inline;"
                >
                  <button type="submit" class="btn-sm">Enable</button>
                </form>
              {% endif %}
            </div>
            {% if not m.monitor_enabled %}
              <div class="muted text-xs" style="margin-top: 4px;">
                
              </div>
              <div class="muted text-xs" style="margin-top: 4px;">
                Activates on next worker cycle.
              </div>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endif %}

<script>
  (function () {
    const key = "sentryml_seen_models_v2";
    let seenMap = {};
    try {
      seenMap = JSON.parse(localStorage.getItem(key) || "{}");
    } catch (e) {
      seenMap = {};
    }
    const links = document.querySelectorAll("a[data-model-id]");
    let hasNew = false;
    links.forEach((link) => {
      const id = link.getAttribute("data-model-id");
      if (!id) return;
      if (!seenMap[id]) {
        hasNew = true;
        const badge = document.createElement("span");
        badge.textContent = "New";
        badge.className = "badge badge-primary";
        badge.style.marginLeft = "8px";
        badge.style.fontSize = "11px";
        badge.style.animation = "slideIn 0.3s ease";
        link.appendChild(badge);
        seenMap[id] = true;
      }
    });
    localStorage.setItem(key, JSON.stringify(seenMap));
    const notice = document.getElementById("model-detected");
    if (notice && hasNew) {
      notice.style.display = "block";
    }
  })();
</script>

<style>
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateX(-10px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
</style>

{% endblock %}
