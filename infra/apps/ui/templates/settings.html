{% extends "base.html" %}
{% block content %}

<h2>Settings</h2>

<h3>Monitoring</h3>
{% if monitors|length == 0 %}
  <p>No models yet. Send prediction events to see monitoring settings.</p>
{% else %}
<table border="1" cellpadding="6" cellspacing="0">
  <tr>
    <th>Model</th>
    <th>Enabled</th>
    <th>Baseline Days</th>
    <th>Current Days</th>
    <th>Bins</th>
    <th>Min Samples</th>
    <th>Warn</th>
    <th>Critical</th>
    <th>Save</th>
  </tr>
  {% for m in monitors %}
  <tr>
    <form id="mon-{{ m.model_id }}" action="/settings/monitor/{{ m.model_id }}" method="post"></form>
    <td>{{ m.model_id }}</td>
    <td><input form="mon-{{ m.model_id }}" type="checkbox" name="is_enabled" {% if m.is_enabled %}checked{% endif %} /></td>
    <td><input form="mon-{{ m.model_id }}" type="number" name="baseline_days" value="{{ m.baseline_days }}" min="1" /></td>
    <td><input form="mon-{{ m.model_id }}" type="number" name="current_days" value="{{ m.current_days }}" min="1" /></td>
    <td><input form="mon-{{ m.model_id }}" type="number" name="num_bins" value="{{ m.num_bins }}" min="2" /></td>
    <td><input form="mon-{{ m.model_id }}" type="number" name="min_samples" value="{{ m.min_samples }}" min="1" /></td>
    <td><input form="mon-{{ m.model_id }}" type="number" name="warn_threshold" value="{{ m.warn_threshold }}" step="0.001" /></td>
    <td><input form="mon-{{ m.model_id }}" type="number" name="critical_threshold" value="{{ m.critical_threshold }}" step="0.001" /></td>
    <td><button form="mon-{{ m.model_id }}" type="submit">Save</button></td>
  </tr>
  {% endfor %}
</table>
{% endif %}

<h3 style="margin-top:20px;">Slack Alerts</h3>
<form action="/settings/slack" method="post" style="margin:10px 0;">
  <label>Slack Webhook URL</label><br/>
  <input type="text" name="slack_webhook_url" style="width:60%;" value="{{ slack.slack_webhook_url if slack else '' }}" />
  <div style="margin-top:8px;">
    <label>
      <input type="checkbox" name="is_enabled" {% if slack and slack.is_enabled %}checked{% endif %} />
      Enabled
    </label>
  </div>
  <button type="submit" style="margin-top:8px;">Update Slack</button>
</form>

<h3 style="margin-top:20px;">API Keys</h3>

{% if new_key %}
  <div style="padding:12px; border:1px solid #ccc; margin:12px 0;">
    <b>Copy this API key now â€” it will not be shown again.</b><br/><br/>
    <code style="display:block; padding:10px; border:1px solid #eee; word-break:break-all;">
      {{ new_key.api_key }}
    </code>
    <div style="margin-top:6px;">
      Prefix: <code>{{ new_key.prefix }}</code>
    </div>
  </div>
{% endif %}

<form action="/settings/api-keys/create" method="post" style="margin:12px 0;">
  <label>Name (optional)</label><br/>
  <input type="text" name="name" placeholder="e.g. prod, staging" />
  <button type="submit">Create new key</button>
</form>

<table border="1" cellpadding="6" cellspacing="0">
  <tr>
    <th>Prefix</th>
    <th>Name</th>
    <th>Created</th>
    <th>Last used</th>
    <th>Status</th>
    <th>Action</th>
  </tr>

  {% for k in keys %}
  <tr>
    <td><code>{{ k.prefix }}</code></td>
    <td>{{ k.name or "" }}</td>
    <td>{{ k.created_at|fmt_dt }}</td>
    <td>{{ k.last_used_at|fmt_dt }}</td>
    <td>
      {% if k.revoked_at %}
        revoked
      {% else %}
        active
      {% endif %}
    </td>
    <td>
      {% if not k.revoked_at %}
      <form action="/settings/api-keys/{{ k.key_id }}/revoke" method="post" style="margin:0;">
        <button type="submit">Revoke</button>
      </form>
      {% endif %}
    </td>
  </tr>
  {% endfor %}
</table>

{% endblock %}
