{% extends "base.html" %}
{% block content %}

<h2>Settings</h2>

<div class="notice">
  <div><b>Org ID</b></div>
  <code id="org-id">{{ org_id or "—" }}</code>
  <button type="button" onclick="copyOrgId()" style="margin-left:8px;">Copy</button>
</div>
<script>
  function copyOrgId() {
    const el = document.getElementById("org-id");
    if (!el) return;
    const text = el.innerText;
    if (text === "—") return;
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).catch(() => fallbackCopy(text));
    } else {
      fallbackCopy(text);
    }
  }
  function fallbackCopy(text) {
    const input = document.createElement("input");
    input.value = text;
    document.body.appendChild(input);
    input.select();
    document.execCommand("copy");
    document.body.removeChild(input);
  }
</script>

<h3>Slack Alerts</h3>
<form action="/settings/slack" method="post" style="margin:10px 0;">
  <label>Slack Webhook URL</label><br/>
  <input type="text" name="slack_webhook_url" style="width:60%;" value="{{ slack.slack_webhook_url if slack else '' }}" />
  <div style="margin-top:8px;">
    <label>
      <input type="checkbox" name="is_enabled" {% if slack and slack.is_enabled %}checked{% endif %} />
      Enabled
    </label>
  </div>
  <button type="submit" style="margin-top:8px;">Update Slack</button>
</form>

<h3 style="margin-top:20px;">API Keys</h3>

{% if new_key %}
  <div style="padding:12px; border:1px solid #ccc; margin:12px 0;">
    <b>Copy this API key now — it will not be shown again.</b><br/><br/>
    <code style="display:block; padding:10px; border:1px solid #eee; word-break:break-all;">
      {{ new_key.api_key }}
    </code>
    <div style="margin-top:6px;">
      Prefix: <code>{{ new_key.prefix }}</code>
    </div>
  </div>
{% endif %}

<form action="/settings/api-keys/create" method="post" style="margin:12px 0;">
  <label>Name (optional)</label><br/>
  <input type="text" name="name" placeholder="e.g. prod, staging" />
  <button type="submit">Create new key</button>
</form>

<table border="1" cellpadding="6" cellspacing="0">
  <tr>
    <th>Prefix</th>
    <th>Name</th>
    <th>Created</th>
    <th>Last used</th>
    <th>Status</th>
    <th>Action</th>
  </tr>

  {% for k in keys %}
  <tr>
    <td><code>{{ k.prefix }}</code></td>
    <td>{{ k.name or "" }}</td>
    <td>{{ k.created_at|fmt_dt }}</td>
    <td>{{ k.last_used_at|fmt_dt }}</td>
    <td>
      {% if k.revoked_at %}
        revoked
      {% else %}
        active
      {% endif %}
    </td>
    <td>
      {% if not k.revoked_at %}
      <form action="/settings/api-keys/{{ k.key_id }}/revoke" method="post" style="margin:0;">
        <button type="submit">Revoke</button>
      </form>
      {% endif %}
    </td>
  </tr>
  {% endfor %}
</table>

{% endblock %}
